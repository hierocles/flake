# VS Code Remote WSL Troubleshooting Log

## Problem
- File operations very slow
- Git Source Control pane constantly "searching" for repo
- Issues started when Claude VS Code extension was installed in WSL

## Changes Made

### 1. modules/users/dylan/ide.nix
- Fixed typo: `files.useExperimentalFileWater` → `files.useExperimentalFileWatcher`
- Added `remote.extensionKind` to force Claude extensions to UI side only:
  ```json
  "remote.extensionKind": {
    "anthropics.claude-code": ["ui"],
    "saoudrizwan.claude-dev": ["ui"]
  }
  ```

### 2. modules/programs/ide.nix
- Changed `nodejsPackage = pkgs.nodejs_latest` → `pkgs.nodejs_22`
- Reason: Node.js 25.4 causes GitHub Copilot Chat to crash with `PendingMigrationError: navigator is now a global in nodejs`, flooding extension host with errors

## Steps Tried
1. Uninstalled Claude extension from both Windows and WSL sides
2. Verified settings applied to `~/.vscode-server/data/Machine/settings.json`
3. Ran `pkill -f vscode-server` to kill server processes
4. Confirmed no residual Claude extension files in `~/.vscode-server/extensions/`

## Current State
- Settings are correctly applied
- Claude extensions uninstalled
- Node.js downgrade applied but not yet tested (needs rebuild + full restart)

## Next Steps After Reboot
1. Rebuild: `sudo nixos-rebuild switch --flake .#wsl`
2. Verify Node.js version used by vscode-server is 22.x
3. If still broken, try:
   - Clear workspace storage: `rm -rf ~/.vscode-server/data/User/workspaceStorage/*`
   - Clear VS Code server cache: `rm -rf ~/.vscode-server/bin/*` (will re-download on connect)
   - Check if Copilot itself needs to be forced to UI side

## Session 2 (Post-reboot)

### Findings
- VS Code server bundles its own Node.js v25.4.0 (ignores system Node.js)
- Copilot Chat still throwing `PendingMigrationError: navigator is now a global in nodejs`
- Error appears in `~/.vscode-server/data/logs/*/exthost*/remoteexthost.log`
- `nodejsPackage = pkgs.nodejs_22` was correctly configured, but...
- The `auto-fix-vscode-server` service only patches *new* installations
- Existing wrapper script in `~/.vscode-server/bin/*/node` still pointed to Node.js 25.4.0

### Root Cause
The nixos-vscode-server module generates wrapper scripts that redirect to the configured Node.js version. After changing `nodejsPackage`, a rebuild alone doesn't update existing wrappers - only new vscode-server installations get the correct version.

### Fix Applied
```bash
rm -rf ~/.vscode-server/bin/*
# Reconnect VS Code - auto-fix-vscode-server regenerates wrappers with Node.js 22
```

### Result
✓ Working - vscode-server now uses Node.js 22, no more navigator errors

## Logs Location
- Extension host logs: `~/.vscode-server/data/logs/*/exthost*/remoteexthost.log`
